
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null;
    }

    // Validation functions based on backend.json entities

    function isValidArticle(data) {
      return data.title is string && data.title.size() > 0 &&
             data.content is string && data.content.size() > 0 &&
             data.category is string && data.category.size() > 0 &&
             data.createdAt is timestamp;
    }

    function isValidPlayer(data) {
      return data.name is string && data.name.size() > 0 &&
             data.position is string && data.position.size() > 0 &&
             data.number is number &&
             data.imageUrl is string && data.imageUrl.size() > 0;
    }

    function isValidMatch(data) {
        return data.date is timestamp &&
               data.competition is string && data.competition.size() > 0 &&
               data.homeTeam is string && data.homeTeam.size() > 0 &&
               data.awayTeam is string && data.awayTeam.size() > 0 &&
               data.status is string && (data.status == 'À venir' || data.status == 'Terminé' || data.status == 'Reporté');
    }

    function isValidPhoto(data) {
        return data.title is string && data.title.size() > 0 &&
               data.imageUrl is string && data.imageUrl.size() > 0 &&
               data.createdAt is timestamp;
    }
    
    function isValidPartner(data) {
        return data.name is string && data.name.size() > 0 &&
               data.logoUrl is string && data.logoUrl.size() > 0;
    }

    function isValidClubInfo(data) {
        // Most fields are optional, so we mainly check types if they exist
        return (!('history' in data) || data.history is string) &&
               (!('presidentWord' in data) || data.presidentWord is string) &&
               (!('presidentWishes' in data) || data.presidentWishes is string);
    }
    
    function isValidContactMessage(data) {
        return data.name is string && data.name.size() > 0 &&
               data.email is string && data.email.size() > 0 &&
               data.subject is string && data.subject.size() > 0 &&
               data.message is string && data.message.size() > 0 &&
               data.createdAt is timestamp &&
               data.isRead is bool;
    }


    // Public read access for most collections
    match /articles/{articleId} { allow read: if true; }
    match /players/{playerId} { allow read: if true; }
    match /matches/{matchId} { allow read: if true; }
    match /photos/{photoId} { allow read: if true; }
    match /partners/{partnerId} { allow read: if true; }
    match /clubInfo/{infoId} { allow read: if true; }


    // Secure write access for managed collections
    match /articles/{articleId} {
      allow create: if isAdmin() && isValidArticle(request.resource.data);
      allow update: if isAdmin() && isValidArticle(request.resource.data);
      allow delete: if isAdmin();
    }

    match /players/{playerId} {
      allow create: if isAdmin() && isValidPlayer(request.resource.data);
      allow update: if isAdmin() && isValidPlayer(request.resource.data);
      allow delete: if isAdmin();
    }

    match /matches/{matchId} {
      allow create: if isAdmin() && isValidMatch(request.resource.data);
      allow update: if isAdmin() && isValidMatch(request.resource.data);
      allow delete: if isAdmin();
    }

    match /photos/{photoId} {
      allow create: if isAdmin() && isValidPhoto(request.resource.data);
      allow update: if isAdmin() && isValidPhoto(request.resource.data);
      allow delete: if isAdmin();
    }

    match /partners/{partnerId} {
        allow create: if isAdmin() && isValidPartner(request.resource.data);
        allow update: if isAdmin() && isValidPartner(request.resource.data);
        allow delete: if isAdmin();
    }

    match /clubInfo/{infoId} {
        allow create, update, delete: if isAdmin() && isValidClubInfo(request.resource.data);
    }
    
    match /contactMessages/{messageId} {
        allow create: if isValidContactMessage(request.resource.data);
        allow read, update, delete: if isAdmin();
    }
  }
}

    